import os, asyncio, json, random, time, requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & VISUALS ---
getcontext().prec = 28
load_dotenv()

# Initialize AI Client
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

OMNI_STRIKE_CACHE = []

# Polymarket CTF Exchange Address
CTF_EXCHANGE = Web3.to_checksum_address("0x4bFbE613d03C895dB366BC36B3D966A488007284")
USDC_NATIVE = Web3.to_checksum_address("0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359")

LOGO = """
<code>‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù v106-AUTH</code>
"""

WIN_LOGO = "<code> ‚úÖ STRIKE SUCCESSFUL: POSITION LOADED</code>"
LOSE_LOGO = "<code> ‚ùå STRIKE FAILED: ORDER REJECTED</code>"

# --- 2. HARDENED CONNECTION GUARD ---
def get_hardened_w3():
    rpc_list = [
        os.getenv("RPC_URL"),
        "https://polygon-rpc.com",
        "https://rpc.ankr.com/polygon",
        "https://1rpc.io/matic"
    ]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

w3 = get_hardened_w3()
if w3 is None: exit(" ‚ò¢Ô∏è CRITICAL ERROR: Polygon RPC Offline.")

# Extended ABI to support Allowance and Approval
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=USDC_NATIVE, abi=ERC20_ABI)

# --- 3. AUTH & VAULT ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if (seed.startswith("0x") or len(seed)==64) else "0x"+seed)
    except: return None

vault = get_vault()
if not vault: exit(" ‚ò¢Ô∏è VAULT ERROR: Check WALLET_SEED in .env")

# CLOB Client Setup
try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except: exit("Missing: pip install py-clob-client")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
try:
    clob_client.set_api_creds(clob_client.create_or_derive_api_creds())
except: print(" ‚ö†Ô∏è API Credentials active.")

# --- 4. HARDENED DISCOVERY ENGINE ---
async def force_scour():
    global OMNI_STRIKE_CACHE
    try:
        url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=40&tag_id=10"
        resp = await asyncio.to_thread(requests.get, url, timeout=15)
        if resp.status_code != 200: return False
        events = resp.json()
        valid_pool = []
        for e in events:
            m = e.get('markets', [])
            if m and m[0].get('clobTokenIds'):
                valid_pool.append({
                    "name": e.get('title', 'CryptoAsset')[:22],
                    "token_id": m[0]['clobTokenIds'][0],
                    "vol": float(e.get('volume', 0))
                })
        if not valid_pool: return False
        valid_pool.sort(key=lambda x: x['vol'], reverse=True)
        OMNI_STRIKE_CACHE = [{"name": x['name'], "side": "UP", "token_id": x['token_id']} for x in valid_pool[:8]]
        return True
    except: return False

async def background_loop():
    while True:
        await force_scour()
        await asyncio.sleep(120)

# --- 5. INTERFACE & EXECUTION ---
async def start(update, context):
    kb = [[' ‚öîÔ∏è START SNIPER', ' ‚öôÔ∏è CALIBRATE'], [' üí≥ VAULT', ' üîÑ REFRESH']]
    await update.message.reply_text(f"{LOGO}\n<b>CRYPTO APEX ONLINE</b>", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    text = update.message.text
    if text == ' ‚öîÔ∏è START SNIPER' or text == ' üîÑ REFRESH':
        msg = await update.message.reply_text(" üì° <b>SCANNING LIQUIDITY...</b>", parse_mode='HTML')
        await force_scour()
        await msg.delete()
        if not OMNI_STRIKE_CACHE:
            await update.message.reply_text(" ‚ò¢Ô∏è <b>SIGNAL LOST.</b>")
            return

        kb = [[InlineKeyboardButton(f"‚Çø {p['name']}", callback_data=f"HIT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
        # INJECTED APPROVE BUTTON
        kb.append([InlineKeyboardButton("üîì APPROVE VAULT (FIX 400 ERR)", callback_data="FIX_APPROVE")])
        
        context.user_data['paths'] = OMNI_STRIKE_CACHE
        await update.message.reply_text(" üåå <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif text == ' ‚öôÔ∏è CALIBRATE':
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 250]]]
        await update.message.reply_text(" ‚öôÔ∏è <b>STRIKE LOAD (USDC):</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif text == ' üí≥ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        report = (f"<code>‚îå‚îÄ‚îÄ VAULT_AUDIT ‚îÄ‚îÄ‚îê\n ‚õΩ POL: {w3.from_wei(raw_pol, 'ether'):.4f}\n üíµ USDC: ${raw_usdc/1e6:.2f}\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code>")
        await update.message.reply_text(report, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()

    if query.data == "FIX_APPROVE":
        v_addr = Web3.to_checksum_address(vault.address)
        allowance = usdc_contract.functions.allowance(v_addr, CTF_EXCHANGE).call()
        if allowance > 10**12: # If already approved for $1M+
            await query.edit_message_text(" ‚úÖ <b>VAULT ALREADY APPROVED.</b>", parse_mode='HTML')
        else:
            await query.edit_message_text(" üõ†Ô∏è <b>SENDING APPROVAL TX...</b>", parse_mode='HTML')
            tx = usdc_contract.functions.approve(CTF_EXCHANGE, 2**256 - 1).build_transaction({
                'from': v_addr, 'nonce': w3.eth.get_transaction_count(v_addr), 'gasPrice': w3.eth.gas_price
            })
            signed = w3.eth.account.sign_transaction(tx, vault.key)
            w3.eth.send_raw_transaction(signed.raw_transaction)
            await query.edit_message_text(" ‚úÖ <b>VAULT AUTHENTICATED.</b>", parse_mode='HTML')

    elif "SET_" in query.data:
        val = int(query.data.split("_")[1]); context.user_data['stake'] = val
        await query.edit_message_text(f" ‚úÖ <b>LOAD SET:</b> <code>${val} USDC</code>", parse_mode='HTML')
        
    elif "HIT_" in query.data:
        idx = int(query.data.split("_")[1]); target = context.user_data['paths'][idx]
        stake = float(context.user_data.get('stake', 10))
        await query.edit_message_text(f" üöÄ <b>STRIKING:</b> <code>{target['name']}</code>", parse_mode='HTML')
        try:
            order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target['token_id'], amount=stake, side=BUY))
            resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
            await context.bot.send_message(query.message.chat_id, WIN_LOGO if resp.get("success") else f"{LOSE_LOGO}: {resp.get('errorMsg')}", parse_mode='HTML')
        except Exception as e:
            await context.bot.send_message(query.message.chat_id, f" ‚ò¢Ô∏è <b>ERROR:</b> <code>{str(e)[:50]}</code>", parse_mode='HTML')

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    loop = asyncio.get_event_loop(); loop.create_task(background_loop())
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































