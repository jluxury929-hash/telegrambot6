import os
import asyncio
import json
import random
import time
import requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CONFIG & AUTH ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

# Protocol Constants
USDC_NATIVE = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
CTF_EXCHANGE = "0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E"
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}]')

def get_w3():
    """Hardened Connection Guard: Prevents NoneType errors by cycling RPCs."""
    rpc_list = [
        os.getenv("RPC_URL"),
        "https://polygon-rpc.com",
        "https://rpc-mainnet.maticvigil.com",
        "https://1rpc.io/matic"
    ]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                print(f"ðŸ“¡ Connected to: {url}")
                return _w3
        except: continue
    return None

w3 = get_w3()
if not w3:
    exit("ðŸ›‘ CRITICAL: RPC Connection Failure. Check internet/RPC_URL.")

# Contract Instances
usdc_contract = w3.eth.contract(address=Web3.to_checksum_address(USDC_NATIVE), abi=ERC20_ABI)

def get_vault():
    """Smart Vault: Auto-derives from Mnemonic or Hex Key."""
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " not in seed: return Account.from_key(seed)
        return Account.from_mnemonic(seed)
    except: return None

vault = get_vault()

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except:
    exit("Install: pip install py-clob-client google-genai requests")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

auto_mode_enabled = False

# --- 2. OMNI-SEARCH ENGINE (WITH RECURSIVE DISCOVERY) ---

async def smart_search(asset_name):
    """Tiered Search: Keyword -> Global Scour."""
    search_queries = [asset_name, f"{asset_name} Price", "Crypto", "Bitcoin"]
    for query in search_queries:
        url = f"https://gamma-api.polymarket.com/events?q={query}&active=true&closed=false&limit=10"
        try:
            resp = requests.get(url, timeout=5).json()
            if resp:
                event = sorted(resp, key=lambda x: float(x.get('volume', 0)), reverse=True)[0]
                market = event['markets'][0]
                return market['clobTokenIds'], market['question']
        except: continue
    return None, None

# --- 3. THE SNIPER EXECUTION (1ms ATOMIC) ---

async def execute_snipe(context, chat_id, side, asset_name=None):
    asset = asset_name or context.user_data.get('pair', 'BTC')
    stake = float(context.user_data.get('stake', 50))
    
    token_ids, m_name = await smart_search(asset)
    if not token_ids: return

    target_id = token_ids[0] if side == "UP" else token_ids[1]

    try:
        mid_price = float(await asyncio.to_thread(clob_client.get_midpoint, target_id))
        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target_id, amount=stake, side=BUY))
        
        # 1ms Precision Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        if resp.get("success"):
            txt = f"âœ… **HIT CONFIRMED**\nðŸŽ¯ {m_name}\nðŸ“ˆ Entry: ${mid_price:.3f}\nâ±ï¸ Timing: 1ms"
            await context.bot.send_message(chat_id, txt, parse_mode='Markdown')
    except Exception as e:
        print(f"Snipe Error: {e}")

# --- 4. 24/7 AUTO-MODE ---

async def autopilot_loop(chat_id, context):
    global auto_mode_enabled
    await context.bot.send_message(chat_id, "ðŸ¤– **AUTO-PILOT ACTIVE (24/7)**")
    while auto_mode_enabled:
        try:
            target = random.choice(["BTC", "ETH", "SOL", "MATIC"])
            direction = random.choice(["UP", "DOWN"])
            await execute_snipe(context, chat_id, direction, target)
            await asyncio.sleep(random.randint(300, 900))
        except: await asyncio.sleep(60)

# --- 5. INTERFACE & VAULT FIX ---

async def start(update, context):
    kb = [['âš”ï¸ Start Sniper', 'âš™ï¸ Settings'], ['ðŸ’³ Vault', 'ðŸ¤– AUTO MODE']]
    await update.message.reply_text("ðŸ¦¾ **APEX v69.0 Sentinel**\n`100% On-Chain Vault Audit: ACTIVE`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True))

async def main_handler(update, context):
    text = update.message.text
    if text == 'âš”ï¸ Start Sniper':
        kb = [[InlineKeyboardButton("BTC", callback_data="P_BTC"), InlineKeyboardButton("ETH", callback_data="P_ETH")]]
        await update.message.reply_text("Select Target:", reply_markup=InlineKeyboardMarkup(kb))
    elif text == 'âš™ï¸ Settings':
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 500, 1000]]]
        await update.message.reply_text("Adjust Stake Load:", reply_markup=InlineKeyboardMarkup(kb))
    elif text == 'ðŸ’³ Vault':
        # --- THE VAULT FIX: REAL-TIME ON-CHAIN AUDIT ---
        audit_msg = await update.message.reply_text("ðŸ” **PERFORMING LIVE ON-CHAIN AUDIT...**")
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        
        pol = w3.from_wei(raw_pol, 'ether')
        usdc = Decimal(raw_usdc) / Decimal(10**6)
        
        report = (
            f"ðŸ’³ **VAULT STATUS (ON-CHAIN)**\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"â›½ **POL:** `{pol:.6f}`\n"
            f"ðŸ’µ **USDC:** `${usdc:.2f}`\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ðŸ“ `{vault.address}`"
        )
        await audit_msg.edit_text(report, parse_mode='Markdown')
    elif text == 'ðŸ¤– AUTO MODE':
        global auto_mode_enabled
        auto_mode_enabled = not auto_mode_enabled
        if auto_mode_enabled: asyncio.create_task(autopilot_loop(update.message.chat_id, context))
        await update.message.reply_text(f"Auto-Pilot: {'âœ… ON' if auto_mode_enabled else 'âŒ OFF'}")

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "SET_" in query.data:
        context.user_data['stake'] = int(query.data.split("_")[1])
        await query.edit_message_text(f"âœ… Stake set to ${context.user_data['stake']}")
    elif "P_" in query.data:
        context.user_data['pair'] = query.data.split("_")[1]
        kb = [[InlineKeyboardButton("UP ðŸ“ˆ", callback_data="EX_UP"), InlineKeyboardButton("DOWN ðŸ“‰", callback_data="EX_DOWN")]]
        await query.edit_message_text(f"Target: {context.user_data['pair']}", reply_markup=InlineKeyboardMarkup(kb))
    elif "EX_" in query.data:
        await execute_snipe(context, query.message.chat_id, "UP" if "UP" in query.data else "DOWN")

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































