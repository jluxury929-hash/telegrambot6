import os, asyncio, json, time, requests, re
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters

# --- 1. CORE CONFIG ---
getcontext().prec = 28
load_dotenv()

# THE PROXY INJECTION (Essential for US/Asia locations)
PROXY_URL = os.getenv("PROXY_URL")
if PROXY_URL:
    os.environ['HTTP_PROXY'] = PROXY_URL
    os.environ['HTTPS_PROXY'] = PROXY_URL

OMNI_STRIKE_CACHE = []

# --- 2. HYDRA RPC ENGINE ---
def get_hydra_w3():
    rpc_endpoints = [os.getenv("RPC_URL"), "https://polygon-rpc.com", "https://rpc.ankr.com/polygon"]
    for url in rpc_endpoints:
        if not url: continue
        try:
            # Proxies={} ensures the RPC connection is direct and fast
            _w3 = Web3(Web3.HTTPProvider(url.strip(), request_kwargs={'proxies': {}, 'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

w3 = get_hydra_w3()

# NATIVE USDC ADDRESS (2026 Standard)
USDC_NATIVE = Web3.to_checksum_address("0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359")
# CLOB EXCHANGE (Handles Native Transactions)
CLOB_EXCHANGE = Web3.to_checksum_address("0x4bFbE613d03C895dB366BC36B3D966A488007284")

ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=USDC_NATIVE, abi=ERC20_ABI)

# --- 3. AUTH & VAULT ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if (seed.startswith("0x") or len(seed)==64) else "0x"+seed)
    except: return None

vault = get_vault()

from py_clob_client.client import ClobClient
from py_clob_client.clob_types import MarketOrderArgs, OrderType
from py_clob_client.order_builder.constants import BUY

def init_clob():
    """
    POLYGON NATIVE USDC FIX:
    Signature Type 1 (EOA) or 2 (Poly-Derived) for Native USDC settlement.
    """
    client = ClobClient(
        host="https://clob.polymarket.com", 
        key=vault.key.hex(), 
        chain_id=137, 
        signature_type=1, # Type 1 usually works best for EOA Native USDC
        funder=vault.address
    )
    try:
        # Derive credentials and verify the handshake
        client.set_api_creds(client.create_or_derive_api_creds())
        return client
    except: return client

clob_client = init_clob()

# --- 4. DATA HARVESTING ---
async def force_scour():
    global OMNI_STRIKE_CACHE
    url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=25"
    try:
        resp = requests.get(url, timeout=10).json()
        pool = []
        for e in resp:
            m = e.get('markets', [])
            if m and m[0].get('clobTokenIds'):
                tid = str(m[0]['clobTokenIds'][0]) # YES Token
                pool.append({
                    "name": e.get('title')[:22], 
                    "q": m[0].get('question'), 
                    "token_id": tid, 
                    "price": float(m[0].get('lastTradePrice', 0.0))
                })
        OMNI_STRIKE_CACHE = pool[:8]
        return True
    except: return False

# --- 5. UI & ATOMIC STRIKE ---
async def start(update, context):
    kb = [['‚öîÔ∏è START SNIPER', '‚öôÔ∏è CALIBRATE'], ['üí≥ VAULT', 'üîÑ REFRESH']]
    await update.message.reply_text("<b>v275: NATIVE USDC READY</b>", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    if update.message.text in ['‚öîÔ∏è START SNIPER', 'üîÑ REFRESH']:
        await force_scour()
        kb = [[InlineKeyboardButton(f"‚Çø {p['name']}", callback_data=f"INTEL_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
        context.user_data['paths'] = OMNI_STRIKE_CACHE
        await update.message.reply_text("üåå <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')
    
    elif update.message.text == 'üí≥ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        allowance = await asyncio.to_thread(usdc_contract.functions.allowance(vault.address, CLOB_EXCHANGE).call)
        report = (f"‚õΩ POL: <code>{w3.from_wei(raw_pol, 'ether'):.4f}</code>\n"
                  f"ü™ô NATIVE USDC: <code>${raw_usdc/1e6:.2f}</code>\n"
                  f"üõ°Ô∏è NATIVE APPROVAL: {'‚úÖ' if allowance > 1e12 else '‚ùå'}")
        kb = [[InlineKeyboardButton("üîì APPROVE NATIVE USDC", callback_data="APPROVE_USDC")]] if allowance < 1e12 else None
        await update.message.reply_text(report, reply_markup=InlineKeyboardMarkup(kb) if kb else None, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    
    if query.data == "APPROVE_USDC":
        await query.edit_message_text("‚ö° <b>SIGNING NATIVE APPROVAL...</b>", parse_mode='HTML')
        try:
            tx = usdc_contract.functions.approve(CLOB_EXCHANGE, 2**256 - 1).build_transaction({
                'from': vault.address, 'nonce': w3.eth.get_transaction_count(vault.address),
                'gas': 100000, 'gasPrice': w3.eth.gas_price
            })
            signed = vault.sign_transaction(tx)
            hash = w3.eth.send_raw_transaction(signed.raw_transaction)
            await context.bot.send_message(query.message.chat_id, f"‚úÖ <b>NATIVE APPROVED:</b> <code>{hash.hex()[:10]}...</code>", parse_mode='HTML')
        except Exception as e:
            await context.bot.send_message(query.message.chat_id, f"‚ò¢Ô∏è <b>FAILED:</b> {str(e)[:50]}")

    elif "INTEL_" in query.data:
        idx = int(query.data.split("_")[1]); target = context.user_data['paths'][idx]
        report = (f"üì° <b>TECHNICAL INTEL REPORT</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                  f"üîπ <b>MARKET:</b> {target['name']}\n"
                  f"üìù <b>INTEL:</b> <i>{target['q']}</i>\n"
                  f"üÜî <b>ASSET ID:</b> <code>{target['token_id']}</code>\n"
                  f"üíπ <b>PRICE:</b> <code>${target['price']:.3f}</code>")
        kb = [[InlineKeyboardButton("üöÄ EXECUTE NATIVE STRIKE", callback_data=f"EXEC_{idx}")]]
        await query.edit_message_text(report, reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif "EXEC_" in query.data:
        idx = int(query.data.split("_")[1]); target = context.user_data['paths'][idx]
        stake = float(context.user_data.get('stake', 10))
        try:
            # Atomic order using Native USDC signature context
            order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target['token_id'], amount=stake, side=BUY))
            resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
            msg = "‚úÖ <b>NATIVE STRIKE SUCCESS</b>" if resp.get("success") else f"‚ùå <b>SIG ERROR:</b> {resp.get('errorMsg')}"
            await context.bot.send_message(query.message.chat_id, msg, parse_mode='HTML')
        except Exception as e:
            await context.bot.send_message(query.message.chat_id, f"‚ò¢Ô∏è <b>ERROR:</b> {str(e)[:50]}")

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































