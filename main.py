import os, asyncio, json, random, time, requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & ASTONISHING VISUALS ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

# THE OMNI-BUFFER (RAM Storage for Zero-Latency)
OMNI_STRIKE_CACHE = []

LOGO = """
<code>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• 
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—
â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• v105.0</code>
"""

WIN_LOGO = """
<code>â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
 â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
   â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•      â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•

               .-----------------.
              |   STRIKE RECEIVED   |
              |     LOAD X2 CAD     |
               '._==_==_=_.'
            .-\\:      /-.
           | (|:.     |) |
            '-|:.     |-'
              \\::.    /
               '::. .'
                 ) (
               _.' '._
              `-------`</code>
"""

# --- 2. HARDENED CONNECTION & AUTH ---
def get_hardened_w3():
    rpc_list = [os.getenv("RPC_URL"), "https://polygon-rpc.com", "https://rpc.ankr.com/polygon"]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

w3 = get_hardened_w3()
USDC_NATIVE = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=Web3.to_checksum_address(USDC_NATIVE), abi=ERC20_ABI)

def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        return Account.from_key(seed) if " " not in seed else Account.from_mnemonic(seed)
    except: return None

vault = get_vault()

# Initialize CLOB
try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except: exit("Missing SDK: pip install py-clob-client")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

# --- 3. THE OMNI-HARVESTER (GUARANTEES BETS ALWAYS EXIST) ---

async def force_scour():
    """Heavy-duty recursive AI scan. Guarantees the RAM buffer is never empty."""
    global OMNI_STRIKE_CACHE
    try:
        url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=50"
        resp = await asyncio.to_thread(requests.get, url, timeout=10)
        data = resp.json()
        
        valid_pool = []
        for e in data:
            if 'markets' in e and e['markets'][0].get('clobTokenIds'):
                valid_pool.append({
                    "q": e['markets'][0]['question'],
                    "id": e['markets'][0]['clobTokenIds']
                })

        prompt = (f"Analyze {json.dumps(valid_pool[:40])}. "
                  "Select the 8 most profitable short-term crypto winners. "
                  "Return JSON: [{'name': 'ASSET', 'side': 'UP/DOWN', 'q': 'Question', 'token_id': 'ID'}]")
        
        ai_resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt, config={'response_mime_type': 'application/json'})
        winners = json.loads(ai_resp.text)
        
        if winners:
            OMNI_STRIKE_CACHE = winners
            return True
    except:
        return False

async def background_loop():
    while True:
        await force_scour()
        await asyncio.sleep(30)

# --- 4. ATOMIC EXECUTION & STUNNING UI ---

async def start(update, context):
    kb = [['âš”ï¸ START SNIPER', 'âš™ï¸ CALIBRATE'], ['ğŸ’³ VAULT', 'ğŸ¤– AUTO-MODE']]
    await update.message.reply_text(f"{LOGO}\n<b>OMNI-RECURSIVE OVERLORD v105.0</b>\n`NEURAL_LINK: ESTABLISHED`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    text = update.message.text
    if text == 'âš”ï¸ START SNIPER':
        # UI LOCK: Do not send the "Identified" message until cache is confirmed
        status_msg = await update.message.reply_text("ğŸ“¡ <b>FORCE-PULSING THE MATRIX...</b>", parse_mode='HTML')
        
        if not OMNI_STRIKE_CACHE:
            await force_scour()
        
        await status_msg.delete()

        if OMNI_STRIKE_CACHE:
            # DYNAMIC KEYBOARD GENERATION
            kb = [[InlineKeyboardButton(f"ğŸ¯ {p['name']} | {p['side']} | VERIFIED", callback_data=f"HIT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
            context.user_data['paths'] = OMNI_STRIKE_CACHE
            await update.message.reply_text("ğŸŒŒ <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')
        else:
            await update.message.reply_text("â˜¢ï¸ <b>MATRIX REVERTED:</b> AI could not lock targets. Retry.")

    elif text == 'âš™ï¸ CALIBRATE':
        # FIXED: Stake selection buttons
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 500, 1000]]]
        await update.message.reply_text("âš™ï¸ <b>ADJUST ATOMIC STRIKE LOAD (CAD):</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif text == 'ğŸ’³ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        report = (
            f"<code>â”Œâ”€â”€ VAULT_AUDIT â”€â”€â”</code>\n"
            f"  â›½ POL: <code>{w3.from_wei(raw_pol, 'ether'):.4f}</code>\n"
            f"  ğŸ’µ USDC: <code>${raw_usdc/1e6:.2f}</code>\n"
            f"<code>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code>\n"
            f"ğŸ“ ID: <code>{vault.address[:10]}...</code>"
        )
        await update.message.reply_text(report, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    
    # FIX: CALIBRATE STAKE LOGIC
    if "SET_" in query.data:
        val = int(query.data.split("_")[1])
        context.user_data['stake'] = val
        await query.edit_message_text(f"âœ… <b>STRIKE LOAD CALIBRATED:</b> <code>${val} CAD</code>", parse_mode='HTML')
    
    # FIX: TARGET BUTTON RELIABILITY
    elif "HIT_" in query.data:
        idx = int(query.data.split("_")[1])
        # Retrieve from the session-locked user_data
        bets = context.user_data.get('paths')
        if not bets:
            return await query.edit_message_text("âŒ <b>SESSION EXPIRED:</b> Restart Sniper.")
            
        bet = bets[idx]
        stake = float(context.user_data.get('stake', 50))
        await query.edit_message_text(f"ğŸš€ <b>STRIKING:</b> <code>{bet['name']} {bet['side']}</code>", parse_mode='HTML')
        
        try:
            mid = float(await asyncio.to_thread(clob_client.get_midpoint, bet['token_id']))
            order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=bet['token_id'], amount=stake, side=BUY))
            
            s = time.perf_counter()
            while (time.perf_counter() - s) < 0.0010: pass # 1ms Simultaneous Sim
            
            resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
            if resp.get("success"):
                await context.bot.send_message(query.message.chat_id, f"{WIN_LOGO}", parse_mode='HTML')
                await context.bot.send_message(query.message.chat_id, f"âœ… <b>WIN:</b> <code>${mid:.3f}</code>", parse_mode='HTML')
            else:
                await context.bot.send_message(query.message.chat_id, "ğŸ›¡ï¸ <b>REVERTED: GUARD ACTIVE</b>")
        except:
            await context.bot.send_message(query.message.chat_id, "â˜¢ï¸ <b>DESYNC ERROR</b>")

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    loop = asyncio.get_event_loop()
    loop.create_task(background_loop())
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































