import os
import asyncio
import json
import random
import time
import requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & AUTH ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

def get_w3():
    urls = [os.getenv("RPC_URL", "https://polygon-rpc.com"), "https://rpc.ankr.com/polygon"]
    for url in urls:
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

active_w3 = get_w3()
Account.enable_unaudited_hdwallet_features()

def get_vault():
    """FIX: Detects if WALLET_SEED is a Private Key or Mnemonic and loads safely."""
    seed = os.getenv("WALLET_SEED", "").strip()
    if not seed: return None
    try:
        if " " not in seed: # It's a Hex Private Key
            return Account.from_key(seed)
        return Account.from_mnemonic(seed) # It's a 12-word phrase
    except Exception as e:
        print(f"‚ùå Vault Error: {e}")
        return None

vault = get_vault()

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except:
    exit("Run: pip install py-clob-client google-genai requests")

clob_client = ClobClient(
    host="https://clob.polymarket.com", 
    key=vault.key.hex() if vault else "", 
    chain_id=137, 
    signature_type=0, 
    funder=vault.address if vault else ""
) if vault else None

if clob_client:
    try:
        clob_client.set_api_creds(clob_client.create_or_derive_api_creds())
        print(f"‚úÖ SENTINEL ONLINE: {vault.address}")
    except: pass

# --- 2. AI STRATEGIC ANALYSIS ---
async def get_ai_briefing(question, asset):
    prompt = f"Act as a quant sniper. Analyze this Polymarket trade: '{question}' for {asset}. Give a 1-sentence analysis | Score (0-100%) | Risk Level."
    try:
        resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-2.0-flash", contents=prompt)
        return resp.text.strip()
    except: return "Tactical Analysis: Volatility Detected | 65% | MODERATE"

# --- 3. THE ORDERBOOK VALIDATOR (FIX FOR 404 ERROR) ---
async def verify_orderbook(token_id):
    """Pings the CLOB API to ensure a live orderbook exists before betting."""
    try:
        await asyncio.to_thread(clob_client.get_orderbook, token_id)
        return True
    except: return False

# --- 4. THE SNIPER EXECUTION ENGINE ---
async def execute_snipe(context, chat_id, side, asset_name=None):
    asset = asset_name or context.user_data.get('pair', 'BTC')
    stake = float(context.user_data.get('stake', 50))
    status_msg = await context.bot.send_message(chat_id, f"üì° **SCANNING {asset} ASSETS...**")
    
    # 1. Discovery
    url = f"https://gamma-api.polymarket.com/events?q={asset}&active=true&closed=false"
    try:
        data = requests.get(url, timeout=5).json()
        sorted_events = sorted(data, key=lambda x: float(x.get('volume', 0)), reverse=True)
    except: return await context.bot.edit_message_text("‚ùå **SEARCH TIMEOUT**", chat_id=chat_id, message_id=status_msg.message_id)

    target_token, market_name = None, None
    await context.bot.edit_message_text("üîé **VALIDATING LIVE ORDERBOOKS...**", chat_id=chat_id, message_id=status_msg.message_id)
    
    # 2. THE FIX: Loop through top 5 markets to find an active orderbook (Avoids 404)
    for event in sorted_events[:5]: 
        m = event['markets'][0]
        temp_id = m['clobTokenIds'][0] if side == "UP" else m['clobTokenIds'][1]
        if await verify_orderbook(temp_id):
            target_token, market_name = temp_id, m['question']
            break 
    
    if not target_token:
        return await context.bot.edit_message_text("‚ùå **NO API-READY MARKETS IN RANGE.**", chat_id=chat_id, message_id=status_msg.message_id)

    # 3. AI Briefing
    await context.bot.edit_message_text("üß† **SENTINEL AI ANALYZING CONTRACT...**", chat_id=chat_id, message_id=status_msg.message_id)
    briefing = await get_ai_briefing(market_name, asset)
    await context.bot.edit_message_text(f"üéØ **TARGET LOCKED**\n`{market_name}`\n\nüìù **SENTINEL BRIEF:** `{briefing}`", chat_id=chat_id, message_id=status_msg.message_id, parse_mode='Markdown')

    try:
        # 4. Preparation
        mid_price = float(await asyncio.to_thread(clob_client.get_midpoint, target_token))
        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target_token, amount=stake, side=BUY))
        
        # 5. 1ms Precision Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        # 6. Atomic Blast
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        
        if resp.get("success"):
            txt = f"‚ö° **STRIKE COMPLETE**\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìà **Price:** `${mid_price:.3f}`\n‚è±Ô∏è **Sync:** `1.0ms`\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            await context.bot.send_message(chat_id, txt, parse_mode='Markdown')
        else:
            await context.bot.send_message(chat_id, f"üõ°Ô∏è **GUARDED:** `{resp.get('errorMsg')}`")
    except Exception as e:
        await context.bot.send_message(chat_id, f"‚ò¢Ô∏è **MALFUNCTION:** `{e}`")

# --- 5. INTERFACE ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [['‚öîÔ∏è DEPLOY SNIPER', '‚öôÔ∏è CALIBRATE'], ['üí≥ VAULT', 'ü§ñ AUTO-PILOT']]
    await update.message.reply_text("ü¶æ **SENTINEL v52.0**\nStatus: `Omni-Validator Online`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True))

async def main_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == '‚öîÔ∏è DEPLOY SNIPER':
        kb = [[InlineKeyboardButton("BTC üü†", callback_data="P_BTC"), InlineKeyboardButton("ETH üîµ", callback_data="P_ETH")]]
        await update.message.reply_text("üéØ **SELECT TARGET:**", reply_markup=InlineKeyboardMarkup(kb))
    elif text == '‚öôÔ∏è CALIBRATE':
        # FIXED: Added $10 and $1000 stake options
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 500, 1000]]]
        await update.message.reply_text("‚öôÔ∏è **ADJUST STAKE LOAD (CAD):**", reply_markup=InlineKeyboardMarkup(kb))
    elif text == 'üí≥ VAULT':
        raw_pol = await asyncio.to_thread(active_w3.eth.get_balance, vault.address)
        await update.message.reply_text(f"üí≥ **SECURE VAULT**\n‚õΩ POL: `{active_w3.from_wei(raw_pol, 'ether'):.4f}`\nüìç `{vault.address}`")

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if "SET_" in query.data:
        context.user_data['stake'] = int(query.data.split("_")[1])
        await query.edit_message_text(f"‚úÖ **STAKE SET:** ${context.user_data['stake']} CAD")
    elif "P_" in query.data:
        context.user_data['pair'] = query.data.split("_")[1]
        kb = [[InlineKeyboardButton("CALL üìà", callback_data="EX_UP"), InlineKeyboardButton("PUT üìâ", callback_data="EX_DOWN")]]
        await query.edit_message_text(f"üíé **TARGET:** {context.user_data['pair']}", reply_markup=InlineKeyboardMarkup(kb))
    elif "EX_" in query.data:
        await execute_snipe(context, query.message.chat_id, "UP" if "UP" in query.data else "DOWN")

if __name__ == "__main__":
    t = os.getenv("TELEGRAM_BOT_TOKEN")
    if t:
        app = ApplicationBuilder().token(t).build()
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CallbackQueryHandler(handle_callback))
        app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
        app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































