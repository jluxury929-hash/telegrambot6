import os
import asyncio
import json
import random
import time
import requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CONFIG & AUTH ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

def get_w3():
    urls = [os.getenv("RPC_URL", "https://polygon-rpc.com"), "https://rpc.ankr.com/polygon"]
    for url in urls:
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

active_w3 = get_w3()
Account.enable_unaudited_hdwallet_features()

# --- THE FIX: SMART WALLET LOADER ---
def get_vault():
    """Detects if WALLET_SEED is a Private Key or Mnemonic and loads safely."""
    seed = os.getenv("WALLET_SEED", "").strip()
    if not seed: return None
    try:
        # If there are no spaces, it's a Private Key
        if " " not in seed:
            return Account.from_key(seed)
        # Otherwise, treat as Mnemonic phrase
        return Account.from_mnemonic(seed)
    except Exception as e:
        print(f"‚ùå WALLET LOAD ERROR: {e}")
        return None

vault = get_vault()

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except:
    print("CRITICAL: Run 'pip install py-clob-client google-genai'")
    exit()

# Auto-Derive for CLOB
clob_client = ClobClient(
    host="https://clob.polymarket.com", 
    key=vault.key.hex() if vault else "", 
    chain_id=137, 
    signature_type=0, 
    funder=vault.address if vault else ""
) if vault else None

if clob_client:
    clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

auto_mode_enabled = False

# --- 2. AI SENTINEL ANALYTICS ---

async def get_ai_briefing(question, asset):
    """AI generates a tactical briefing for the trade."""
    prompt = f"""
    Act as a high-stakes quantitative analyst. 
    Analyze this Polymarket trade: "{question}" for {asset}.
    1. Give a 1-sentence 'Tactical Analysis'.
    2. Assign a 'Confidence Score' (0-100%).
    3. State if it's a 'SAFE' or 'RISKY' play.
    Format your response exactly like this: Analysis | Score | Risk
    """
    try:
        response = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-2.0-flash", contents=prompt)
        return response.text.strip()
    except:
        return "Analysis Offline | 50% | UNKNOWN"

# --- 3. OMNI-SEARCH ENGINE ---

async def smart_search(asset_name):
    search_queries = [asset_name, f"{asset_name} Price"]
    for query in search_queries:
        url = f"https://gamma-api.polymarket.com/events?q={query}&active=true&closed=false"
        try:
            resp = requests.get(url, timeout=5).json()
            if resp:
                event = sorted(resp, key=lambda x: float(x.get('volume', 0)), reverse=True)[0]
                market = event['markets'][0]
                return market['clobTokenIds'], market['question'], event.get('description', '')
        except: continue
    return None, None, None

# --- 4. THE SNIPER EXECUTION ---

async def execute_snipe(context, chat_id, side, asset_name=None):
    asset = asset_name or context.user_data.get('pair', 'BTC')
    stake = float(context.user_data.get('stake', 50))
    
    status_msg = await context.bot.send_message(chat_id, "üì° **INITIATING OMNI-SCAN...**")
    
    # 1. Discover
    token_ids, m_name, desc = await smart_search(asset)
    if not token_ids:
        return await context.bot.edit_message_text("‚ùå **NO TARGETS IN RANGE.**", chat_id=chat_id, message_id=status_msg.message_id)

    # 2. AI Briefing
    await context.bot.edit_message_text("üß† **SENTINEL AI ANALYZING CONTRACT...**", chat_id=chat_id, message_id=status_msg.message_id)
    briefing = await get_ai_briefing(m_name, asset)
    
    await context.bot.edit_message_text(
        f"üéØ **TARGET LOCKED**\n`{m_name}`\n\nüìù **BRIEFING:**\n`{briefing}`", 
        chat_id=chat_id, message_id=status_msg.message_id, parse_mode='Markdown'
    )

    target_id = token_ids[0] if side == "UP" else token_ids[1]

    try:
        # 3. Parallel Prep
        mid_price = float(await asyncio.to_thread(clob_client.get_midpoint, target_id))
        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target_id, amount=stake, side=BUY))
        
        # 4. Precision Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        # 5. Atomic Post
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        
        if resp.get("success"):
            report = (
                f"‚ö° **STRIKE COMPLETE**\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"üìà **Entry:** `${mid_price:.3f}`\n"
                f"‚è±Ô∏è **Sync:** `1.0ms`\n"
                f"üîó **ID:** `{resp.get('orderID')[:12]}...`\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            )
            await context.bot.send_message(chat_id, report, parse_mode='Markdown')
    except Exception as e:
        await context.bot.send_message(chat_id, f"‚ò¢Ô∏è **SYSTEM MALFUNCTION:** `{e}`")

# --- 5. INTERFACE ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [['‚öîÔ∏è DEPLOY SNIPER', '‚öôÔ∏è CALIBRATE'], ['üí≥ VAULT', 'ü§ñ AUTO-PILOT']]
    welcome = (
        "ü¶æ **APEX v50.0: THE SENTINEL**\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üì° **Status:** `SYSTEM READY`\n"
        "üß† **AI:** `Gemini-2.0-Flash Online`\n"
        "‚ö° **Sync:** `1ms Hardware Lock`"
    )
    await update.message.reply_text(welcome, reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='Markdown')

async def main_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == '‚öîÔ∏è DEPLOY SNIPER':
        kb = [[InlineKeyboardButton("BTC", callback_data="P_BTC"), InlineKeyboardButton("ETH", callback_data="P_ETH")]]
        await update.message.reply_text("üéØ **SELECT TARGET ASSET:**", reply_markup=InlineKeyboardMarkup(kb))
    elif text == '‚öôÔ∏è CALIBRATE':
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [50, 100, 500]]]
        await update.message.reply_text("‚öôÔ∏è **ADJUST STAKE LOAD:**", reply_markup=InlineKeyboardMarkup(kb))
    elif text == 'üí≥ VAULT':
        raw_pol = await asyncio.to_thread(active_w3.eth.get_balance, vault.address)
        await update.message.reply_text(f"üí≥ **VAULT SECURE**\n‚õΩ POL: `{active_w3.from_wei(raw_pol, 'ether'):.4f}`\nüìç `{vault.address}`")
    elif text == 'ü§ñ AUTO-PILOT':
        global auto_mode_enabled
        auto_mode_enabled = not auto_mode_enabled
        if auto_mode_enabled: asyncio.create_task(autopilot_loop(update.message.chat_id, context))
        await update.message.reply_text(f"ü§ñ **Auto-Pilot: {'‚úÖ ON' if auto_mode_enabled else 'üõë OFF'}**")

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if "SET_" in query.data:
        context.user_data['stake'] = int(query.data.split("_")[1])
        await query.edit_message_text(f"‚úÖ **STAKE CALIBRATED:** ${context.user_data['stake']}")
    elif "P_" in query.data:
        context.user_data['pair'] = query.data.split("_")[1]
        kb = [[InlineKeyboardButton("CALL üìà", callback_data="EX_UP"), InlineKeyboardButton("PUT üìâ", callback_data="EX_DOWN")]]
        await query.edit_message_text(f"üíé **TARGET:** {context.user_data['pair']}\n**DIRECTION?**", reply_markup=InlineKeyboardMarkup(kb))
    elif "EX_" in query.data:
        await execute_snipe(context, query.message.chat_id, "UP" if "UP" in query.data else "DOWN")

async def autopilot_loop(chat_id, context):
    global auto_mode_enabled
    while auto_mode_enabled:
        try:
            await execute_snipe(context, chat_id, random.choice(["UP", "DOWN"]), random.choice(["BTC", "ETH"]))
            await asyncio.sleep(random.randint(300, 900))
        except: await asyncio.sleep(60)

if __name__ == "__main__":
    t = os.getenv("TELEGRAM_BOT_TOKEN")
    if t:
        app = ApplicationBuilder().token(t).build()
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CallbackQueryHandler(handle_callback))
        app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
        app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































