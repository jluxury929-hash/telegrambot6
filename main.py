import os
import asyncio
import json
import time
import requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & AUTH ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

def get_w3():
    urls = [os.getenv("RPC_URL", "https://polygon-rpc.com"), "https://rpc.ankr.com/polygon"]
    for url in urls:
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

active_w3 = get_w3()
Account.enable_unaudited_hdwallet_features()

def get_vault():
    """Smart load: Handles Hex Private Key or Mnemonic Seed."""
    seed = os.getenv("WALLET_SEED", "").strip()
    if not seed: return None
    try:
        return Account.from_key(seed) if " " not in seed else Account.from_mnemonic(seed)
    except Exception as e:
        print(f"âŒ Vault Error: {e}")
        return None

vault = get_vault()

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except:
    exit("Run: pip install py-clob-client google-genai requests")

clob_client = ClobClient(
    host="https://clob.polymarket.com", 
    key=vault.key.hex() if vault else "", 
    chain_id=137, 
    signature_type=0, 
    funder=vault.address if vault else ""
) if vault else None

if clob_client:
    try: clob_client.set_api_creds(clob_client.create_or_derive_api_creds())
    except: pass

# --- 2. NEURAL PRE-PROCESSOR & RECURSIVE VALIDATOR ---

async def verify_orderbook(token_id):
    """Pings the CLOB to ensure orderbook exists (Prevents 404)."""
    try:
        await asyncio.to_thread(clob_client.get_orderbook, token_id)
        return True
    except: return False

async def neural_screen(market_data):
    """Parallel AI Screening: Predicts winner and verifies liquidity."""
    question = market_data['question']
    prompt = f"Trade Analysis: '{question}'. Predict win: 'UP' or 'DOWN'. If unsure, 'SKIP'. Return 1 word ONLY."
    try:
        # Use Gemini 1.5 Flash for the fastest possible screening
        resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt)
        decision = resp.text.strip().upper()
        
        if decision in ['UP', 'DOWN']:
            token_id = market_data['clobTokenIds'][0] if decision == "UP" else market_data['clobTokenIds'][1]
            # Double-check: Only suggest if the orderbook is live
            if await verify_orderbook(token_id):
                return {"market": market_data, "side": decision}
    except: pass
    return None

async def discovery_matrix(keyword):
    """Scans 30 markets simultaneously and returns AI-verified winning paths."""
    # Recursive search strategy: Asset -> Crypto Trending
    search_queries = [keyword, "Crypto", "Bitcoin"]
    for q in search_queries:
        url = f"https://gamma-api.polymarket.com/events?q={q}&active=true&closed=false&limit=30"
        try:
            resp = requests.get(url, timeout=5).json()
            valid_pool = [e['markets'][0] for e in resp if 'markets' in e and len(e['markets'][0]['clobTokenIds']) == 2]
            
            # Parallel Neural Strike: Screen all candidates at once
            tasks = [neural_screen(m) for m in valid_pool]
            results = await asyncio.gather(*tasks)
            winning_paths = [r for r in results if r is not None]
            
            if winning_paths: return winning_paths
        except: continue
    return []

# --- 3. ATOMIC SNIPER ENGINE ---

async def execute_neural_strike(context, chat_id, path):
    stake = float(context.user_data.get('stake', 50))
    m = path['market']
    side = path['side']
    token_id = m['clobTokenIds'][0] if side == "UP" else m['clobTokenIds'][1]
    
    msg = await context.bot.send_message(chat_id, f"âš¡ **STRIKE INITIATED: {side}**")
    
    try:
        mid_price = float(await asyncio.to_thread(clob_client.get_midpoint, token_id))
        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=token_id, amount=stake, side=BUY))
        
        # 1.0ms Precision Hardware Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        
        if resp.get("success"):
            report = (f"âœ… **WIN CONFIRMED**\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸŽ¯ {m['question']}\n"
                      f"ðŸ“ˆ Entry: `${mid_price:.3f}`\nâ±ï¸ Sync: `1.0ms`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”")
            await context.bot.edit_message_text(report, chat_id=chat_id, message_id=msg.message_id, parse_mode='Markdown')
        else:
            await context.bot.edit_message_text(f"ðŸ›¡ï¸ **GUARDED:** {resp.get('errorMsg')}", chat_id=chat_id, message_id=msg.message_id)
    except Exception as e:
        await context.bot.edit_message_text(f"â˜¢ï¸ **MALFUNCTION:** {e}", chat_id=chat_id, message_id=msg.message_id)

# --- 4. INTERFACE ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [['âš”ï¸ DEPLOY SNIPER', 'âš™ï¸ CALIBRATE'], ['ðŸ’³ VAULT', 'ðŸ¤– AUTO-MODE']]
    await update.message.reply_text("ðŸ¦¾ **APEX v57.0: NEURAL SENTINEL**\nStatus: `Parallel recursive Matrix Online`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True))

async def main_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == 'âš”ï¸ DEPLOY SNIPER':
        status = await update.message.reply_text("ðŸ“¡ **SCANNING NEURAL NETWORK FOR WINNING PATHS...**")
        
        # Instant Parallel Recursive Discovery
        winning_paths = await discovery_matrix("Crypto")
        
        if not winning_paths:
            return await status.edit_text("âŒ No high-confidence trades found. Retrying scan...")

        kb = []
        for i, path in enumerate(winning_paths[:6]): # Show top 6 AI-approved strikes
            q_short = path['market']['question'][:32] + "..."
            kb.append([InlineKeyboardButton(f"ðŸŽ¯ {q_short} | {path['side']}", callback_data=f"STRIKE_{i}")])
        
        context.user_data['active_paths'] = winning_paths
        await status.edit_text("ðŸŽ¯ **AI-VERIFIED WINNING PATHS IDENTIFIED:**", reply_markup=InlineKeyboardMarkup(kb))

    elif text == 'âš™ï¸ CALIBRATE':
        # Added $10 and $1000 stake options
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 500, 1000]]]
        await update.message.reply_text("âš™ï¸ **ADJUST STAKE LOAD (CAD):**", reply_markup=InlineKeyboardMarkup(kb))
        
    elif text == 'ðŸ’³ VAULT':
        raw_pol = await asyncio.to_thread(active_w3.eth.get_balance, vault.address)
        await update.message.reply_text(f"ðŸ’³ **SECURE VAULT**\nâ›½ POL: `{active_w3.from_wei(raw_pol, 'ether'):.4f}`\nðŸ“ `{vault.address}`")

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if "SET_" in query.data:
        context.user_data['stake'] = int(query.data.split("_")[1])
        await query.edit_message_text(f"âœ… **STAKE SET:** ${context.user_data['stake']} CAD")
    elif "STRIKE_" in query.data:
        idx = int(query.data.split("_")[1])
        path = context.user_data['active_paths'][idx]
        await execute_neural_strike(context, query.message.chat_id, path)

if __name__ == "__main__":
    t = os.getenv("TELEGRAM_BOT_TOKEN")
    if t:
        app = ApplicationBuilder().token(t).build()
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CallbackQueryHandler(handle_callback))
        app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
        app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































