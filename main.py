import os, asyncio, json, random, time, requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & ASTONISHING VISUALS ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

OMNI_STRIKE_CACHE = []

LOGO = """
<code>‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù v100-VAULT-FIX</code>
"""

WIN_LOGO = "<code>‚úÖ STRIKE SUCCESSFUL: POSITION LOADED</code>"
LOSE_LOGO = "<code>‚ùå STRIKE FAILED: REVERTING...</code>"

# --- 2. HARDENED CONNECTION & AUTH ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if (seed.startswith("0x") or len(seed)==64) else "0x"+seed)
    except: return None

vault = get_vault()

def get_w3():
    rpc_list = [os.getenv("RPC_URL"), "https://polygon-rpc.com", "https://rpc.ankr.com/polygon"]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

w3 = get_w3()
USDC_NATIVE = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
CTF_EXCHANGE = "0x4bFbE613d03C895dB366BC36B3D966A488007284"

# Hardened ABI for Balance and Approval
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=Web3.to_checksum_address(USDC_NATIVE), abi=ERC20_ABI)

# --- 3. VAULT PROTOCOL HANDSHAKE ---
def preflight_vault_auth():
    """Ensures the exchange is authorized to handle vault funds before execution."""
    addr = Web3.to_checksum_address(vault.address)
    try:
        allowance = usdc_contract.functions.allowance(addr, Web3.to_checksum_address(CTF_EXCHANGE)).call()
        if allowance < 10**12: # Check if less than $1M USDC is approved
            print("üõ†Ô∏è  AUTHENTICATING VAULT: Sending Approval...")
            tx = usdc_contract.functions.approve(Web3.to_checksum_address(CTF_EXCHANGE), 2**256 - 1).build_transaction({
                'from': addr, 'nonce': w3.eth.get_transaction_count(addr), 'gasPrice': w3.eth.gas_price
            })
            signed_tx = w3.eth.account.sign_transaction(tx, vault.key)
            w3.eth.send_raw_transaction(signed_tx.raw_transaction)
            print("‚úÖ VAULT AUTHENTICATED")
    except Exception as e:
        print(f"‚ö†Ô∏è VAULT AUTH BYPASSED: {e}")

# Initialize CLOB
try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except: exit("Missing SDK: pip install py-clob-client")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=1, funder=vault.address)

# --- 4. THE OMNI-HARVESTER ---
async def force_scour():
    global OMNI_STRIKE_CACHE
    try:
        url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=40&tag_id=10"
        resp = requests.get(url, timeout=10).json()
        valid_pool = []
        for e in resp:
            markets = e.get('markets', [])
            if markets and markets[0].get('clobTokenIds'):
                valid_pool.append({"q": markets[0]['question'], "id": markets[0]['clobTokenIds']})

        prompt = f"Analyze {json.dumps(valid_pool[:30])}. Select 8 winners. Return JSON: [{{'name': 'ASSET', 'side': 'UP', 'token_id': 'ID'}}]"
        ai_resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt, config={'response_mime_type': 'application/json'})
        winners = json.loads(ai_resp.text)
        if winners: OMNI_STRIKE_CACHE = winners
        return True
    except Exception as e:
        print(f"Scour Delay: {e}")
        return False

# --- 5. UI & EXECUTION ---
async def start(update, context):
    kb = [['‚öîÔ∏è START SNIPER', '‚öôÔ∏è CALIBRATE'], ['üí≥ VAULT', 'üîÑ REFRESH']]
    await update.message.reply_text(f"{LOGO}\n<b>OVERLORD v100 READY</b>", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    text = update.message.text
    if text in ['‚öîÔ∏è START SNIPER', 'üîÑ REFRESH']:
        if not OMNI_STRIKE_CACHE: await force_scour()
        kb = [[InlineKeyboardButton(f"‚Çø {p['name']} | {p['token_id'][:6]}", callback_data=f"HIT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
        context.user_data['paths'] = OMNI_STRIKE_CACHE
        await update.message.reply_text("üåå <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif text == '‚öôÔ∏è CALIBRATE':
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 250]]]
        await update.message.reply_text("‚öôÔ∏è <b>LOAD ATOMIC STRIKE:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif text == 'üí≥ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        report = (
            f"<b>VAULT AUDIT</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"‚õΩ POL: <code>{w3.from_wei(raw_pol, 'ether'):.4f}</code>\n"
            f"üíµ USDC: <code>${raw_usdc/1e6:.2f}</code>\n"
            f"üÜî ADDR: <code>{vault.address[:8]}...</code>"
        )
        await update.message.reply_text(report, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "HIT_" in query.data:
        idx = int(query.data.split("_")[1])
        target = context.user_data['paths'][idx]
        stake = float(context.user_data.get('stake', 50))
        await query.edit_message_text(f"üöÄ <b>STRIKING:</b> <code>{target['name']}</code>", parse_mode='HTML')
        try:
            order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target['token_id'], amount=stake, side=BUY))
            resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
            msg = WIN_LOGO if resp.get("success") else LOSE_LOGO
            await context.bot.send_message(query.message.chat_id, msg, parse_mode='HTML')
        except: await context.bot.send_message(query.message.chat_id, "‚ò¢Ô∏è <b>DESYNC ERROR</b>")

if __name__ == "__main__":
    preflight_vault_auth() # Ensure Vault is ready before boot
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































