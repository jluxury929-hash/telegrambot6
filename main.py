import os, asyncio, json, random, time, requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & ASTONISHING VISUALS ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

OMNI_STRIKE_CACHE = []

LOGO = """
<code>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ–ˆâ•”â• 
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•    â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—
â•šâ•â•  â•šâ•â•â•šâ•â•      â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• v102</code>
"""

WIN_LOGO = """
<code>           â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
           â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
            â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
             â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
              â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
              â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•

               .-----------------.
              |   STRIKE RECEIVED   |
              |      LOAD X2 CAD     |
               '._==_==_=_.'
            .-\\:      /-.
           | (|:.     |) |
            '-|:.     |-'
              \\::.    /
               '::. .'
                 ) (
               _.' '._
              `-------`</code>
"""

LOSE_LOGO = """
<code>           â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
           â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
           â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
           â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  
           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
           â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•

                  â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„
                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                 â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ
                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                   â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
                   â–€â–€  â–€â–€  â–€â–€
               [SYSTEM_REVERTED]</code>
"""

# --- 2. THE UNBREAKABLE CONNECTION GUARD ---
def get_hardened_w3():
    rpc_list = [
        os.getenv("RPC_URL"),
        "https://polygon-rpc.com",
        "https://rpc.ankr.com/polygon",
        "https://1rpc.io/matic",
        "https://polygon.llamarpc.com"
    ]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                print(f"ğŸ“¡ NODE_LINK_ESTABLISHED: {url}")
                return _w3
        except: continue
    return None

w3 = get_hardened_w3()
if w3 is None: exit("â˜¢ï¸ CRITICAL ERROR: All Polygon RPC Nodes Unreachable.")

USDC_NATIVE = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=Web3.to_checksum_address(USDC_NATIVE), abi=ERC20_ABI)

# --- 3. AUTH & AI DISCOVERY ENGINE ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if seed.startswith("0x") else "0x"+seed)
    except: return None

vault = get_vault()

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except: exit("Install: pip install py-clob-client google-genai requests")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

async def force_scour():
    global OMNI_STRIKE_CACHE
    try:
        url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=50"
        resp = await asyncio.to_thread(requests.get, url, timeout=10)
        events = resp.json()
        
        valid_pool = []
        for e in events:
            if 'markets' in e and e['markets'][0].get('clobTokenIds'):
                # Pass more context to AI so it doesn't fail to identify 'side'
                valid_pool.append({"q": e['markets'][0]['question'], "id": e['markets'][0]['clobTokenIds']})

        prompt = (f"Analyze {json.dumps(valid_pool[:40])}. "
                  "Select the 8 most profitable short-term winners. "
                  "Return JSON ONLY as a LIST of objects. Each object MUST have: 'name' (short title), 'side' (UP/DOWN), 'q' (Question), and 'token_id' (first ID from the list).")
        
        ai_resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt, config={'response_mime_type': 'application/json'})
        winners = json.loads(ai_resp.text)
        if winners and isinstance(winners, list):
            OMNI_STRIKE_CACHE = winners
            print(f"ğŸ”¥ BUFFER RELOADED: {len(OMNI_STRIKE_CACHE)} Paths Confirmed.")
            return True
    except Exception as e:
        print(f"AI ERROR: {e}")
    return False

async def background_loop():
    while True:
        await force_scour()
        await asyncio.sleep(35)

# --- 4. ARCADE INTERFACE & ATOMIC STRIKE ---
async def start(update, context):
    kb = [['âš”ï¸ START SNIPER', 'âš™ï¸ CALIBRATE'], ['ğŸ’³ VAULT', 'ğŸ¤– AUTO-MODE']]
    await update.message.reply_text(f"{LOGO}\n<b>APEX OMEGA ONLINE</b>\n`READY_P1`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    if update.message.text == 'âš”ï¸ START SNIPER':
        # FIX: Send loading message and AWAIT the scour before proceeding
        msg = await update.message.reply_text("ğŸ“¡ <b>NEURAL PULSE INITIATED... SCOURING MARKETS...</b>", parse_mode='HTML')
        
        # We always scour on manual click to ensure fresh data
        success = await force_scour()
        
        if not OMNI_STRIKE_CACHE or not success:
            await msg.edit_text("âŒ <b>SIGNAL LOST:</b> AI could not identify profitable targets. Try again.")
            return

        kb = [[InlineKeyboardButton(f"ğŸ¯ {p.get('name', 'ASSET')} | {p.get('side', 'STRIKE')} | WIN_VERIFIED", callback_data=f"HIT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
        context.user_data['paths'] = OMNI_STRIKE_CACHE
        
        await msg.delete()
        await update.message.reply_text("ğŸŒŒ <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif update.message.text == 'âš™ï¸ CALIBRATE':
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 500, 1000]]]
        await update.message.reply_text("âš™ï¸ <b>ADJUST ATOMIC STRIKE LOAD (CAD):</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif update.message.text == 'ğŸ’³ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        report = (
            f"<code>â”Œâ”€â”€ VAULT_AUDIT â”€â”€â”</code>\n"
            f"  â›½ POL: <code>{w3.from_wei(raw_pol, 'ether'):.4f}</code>\n"
            f"  ğŸ’µ USDC: <code>${raw_usdc/1e6:.2f}</code>\n"
            f"<code>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code>\n"
            f"ğŸ“ ID: <code>{vault.address[:10]}...</code>"
        )
        await update.message.reply_text(report, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "SET_" in query.data:
        val = int(query.data.split("_")[1])
        context.user_data['stake'] = val
        await query.edit_message_text(f"âœ… <b>STRIKE LOAD CALIBRATED:</b> <code>${val} CAD</code>", parse_mode='HTML')
    elif "HIT_" in query.data:
        idx = int(query.data.split("_")[1])
        # Defensive check for index errors
        if 'paths' not in context.user_data or idx >= len(context.user_data['paths']):
            await query.edit_message_text("âŒ <b>STALE TARGET.</b> Please re-scan.")
            return
            
        bet = context.user_data['paths'][idx]
        stake = float(context.user_data.get('stake', 50))
        await query.edit_message_text(f"ğŸš€ <b>STRIKING:</b> <code>{bet['name']} {bet['side']}</code>", parse_mode='HTML')
        try:
            # We use the first token_id from the list returned by the AI
            t_id = bet['token_id'][0] if isinstance(bet['token_id'], list) else bet['token_id']
            order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=t_id, amount=stake, side=BUY))
            
            # High-speed delay logic as requested
            s = time.perf_counter()
            while (time.perf_counter() - s) < 0.0010: pass
            
            resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
            await context.bot.send_message(query.message.chat_id, WIN_LOGO if resp.get("success") else LOSE_LOGO, parse_mode='HTML')
        except Exception as e:
            print(f"STRIKE FAIL: {e}")
            await context.bot.send_message(query.message.chat_id, "â˜¢ï¸ <b>DESYNC</b>")

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    loop = asyncio.get_event_loop(); loop.create_task(background_loop())
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































