import os, asyncio, json, random, time, requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & ASTONISHING VISUALS ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

OMNI_STRIKE_CACHE = []

LOGO = """
<code>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• 
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—
â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• v104.0</code>
"""

WIN_LOGO = """
<code>          â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
          â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
           â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
            â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
             â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
             â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•
               .-----------------.
              |   STRIKE RECEIVED   |
              |     LOAD X2 CAD     |
               '._==_==_=_.'
            .-\\:      /-.
           | (|:.     |) |
            '-|:.     |-'
              \\::.    /
               '::. .'
                 ) (
               _.' '._
              `-------`</code>
"""

# --- 2. HARDENED RECURSIVE NODE GUARD ---
def get_w3():
    """Cycles through multiple high-performance RPCs to guarantee connection."""
    rpc_list = [
        os.getenv("RPC_URL"),
        "https://polygon-rpc.com",
        "https://rpc.ankr.com/polygon",
        "https://1rpc.io/matic",
        "https://polygon.llamarpc.com"
    ]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 15}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                print(f"ğŸ“¡ NODE_ACTIVE: {url}")
                return _w3
        except: continue
    return None

w3 = get_w3()
if w3 is None: exit("â˜¢ï¸ FATAL: RPC NODES UNREACHABLE. RECHECK .ENV")

USDC_NATIVE = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=Web3.to_checksum_address(USDC_NATIVE), abi=ERC20_ABI)

def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if seed.startswith("0x") else "0x"+seed)
    except: return None

vault = get_vault()

# CLOB Initialization with Retry logic
try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
    clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
    clob_client.set_api_creds(clob_client.create_or_derive_api_creds())
except: exit("â˜¢ï¸ CLOB_SYNC_FAILED: Install py-clob-client")

# --- 3. AI-GUARANTEED DISCOVERY ENGINE ---

async def force_scour():
    """Ensures bets always appear by using a 3-layer AI fallback."""
    global OMNI_STRIKE_CACHE
    for attempt in range(3): # Recursive Retry
        try:
            url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=50"
            resp = await asyncio.to_thread(requests.get, url, timeout=12)
            data = resp.json()
            
            valid_pool = [{"q": e['markets'][0]['question'], "id": e['markets'][0]['clobTokenIds']} 
                          for e in data if 'markets' in e and e['markets'][0].get('clobTokenIds')]

            prompt = (f"Analyze {json.dumps(valid_pool[:45])}. Select 8 high-conf short-term winners. "
                      "Return JSON ONLY: [{'name': 'ASSET', 'side': 'UP/DOWN', 'q': 'Question', 'token_id': 'ID'}]")
            
            ai_resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt, config={'response_mime_type': 'application/json'})
            winners = json.loads(ai_resp.text)
            
            if winners:
                OMNI_STRIKE_CACHE = winners
                return True
        except:
            await asyncio.sleep(2)
    return False

async def background_loop():
    while True:
        await force_scour()
        await asyncio.sleep(25)

# --- 4. ARCADE INTERFACE ---

async def start(update, context):
    kb = [['âš”ï¸ START SNIPER', 'âš™ï¸ CALIBRATE'], ['ğŸ’³ VAULT', 'ğŸ¤– AUTO-MODE']]
    await update.message.reply_text(f"{LOGO}\n<b>OMNI-RECURSIVE ONLINE</b>\n`NODE_HEALTH: 100%`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    if update.message.text == 'âš”ï¸ START SNIPER':
        msg = await update.message.reply_text("ğŸ“¡ <b>FORCE-PULSING NODES...</b>", parse_mode='HTML')
        if not OMNI_STRIKE_CACHE:
            await force_scour()
        await msg.delete()

        if OMNI_STRIKE_CACHE:
            kb = [[InlineKeyboardButton(f"ğŸ¯ {p['name']} | {p['side']} | VERIFIED", callback_data=f"HIT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
            context.user_data['paths'] = OMNI_STRIKE_CACHE
            await update.message.reply_text("ğŸŒŒ <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')
        else:
            await update.message.reply_text("â˜¢ï¸ <b>NETWORK_ERROR:</b> NODE SATURATED. RETRYING...")

    elif update.message.text == 'ğŸ’³ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        report = f"<code>â”Œâ”€â”€ VAULT_AUDIT â”€â”€â”</code>\n  â›½ POL: <code>{w3.from_wei(raw_pol, 'ether'):.4f}</code>\n  ğŸ’µ USDC: <code>${raw_usdc/1e6:.2f}</code>\n<code>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code>"
        await update.message.reply_text(report, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "HIT_" in query.data:
        idx = int(query.data.split("_")[1])
        bet = context.user_data['paths'][idx]
        stake = float(context.user_data.get('stake', 50))
        await query.edit_message_text(f"ğŸš€ <b>STRIKING:</b> <code>{bet['name']} {bet['side']}</code>", parse_mode='HTML')
        try:
            order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=bet['token_id'], amount=stake, side=BUY))
            s = time.perf_counter()
            while (time.perf_counter() - s) < 0.0010: pass 
            resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
            await context.bot.send_message(query.message.chat_id, WIN_LOGO if resp.get("success") else "ğŸ›¡ï¸ <b>REVERTED</b>", parse_mode='HTML')
        except: await context.bot.send_message(query.message.chat_id, "â˜¢ï¸ <b>NODE_DESYNC</b>")

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    loop = asyncio.get_event_loop(); loop.create_task(background_loop())
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































