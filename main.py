import os, asyncio, json, time, requests, re
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters
from google import genai

# --- 1. CORE CONFIG ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))
OMNI_STRIKE_CACHE = []

USDC_NATIVE = Web3.to_checksum_address("0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359")
CTF_EXCHANGE = Web3.to_checksum_address("0x4bFbE613d03C895dB366BC36B3D966A488007284")

LOGO = """
<code>‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù v170-HYDRA-FIX</code>
"""

# --- 2. HYDRA RPC ENGINE (FIXES FATAL CONNECTION ERROR) ---
def get_hydra_w3():
    """Forces a connection by cycling nodes until a pulse is found."""
    # 2026 Updated High-Availability RPC List
    rpc_endpoints = [
        os.getenv("RPC_URL"),
        "https://polygon-rpc.com",
        "https://rpc.ankr.com/polygon",
        "https://polygon.llamarpc.com",
        "https://1rpc.io/matic",
        "https://polygon.drpc.org",
        "https://poly-rpc.gateway.pokt.network"
    ]
    
    for url in rpc_endpoints:
        if not url: continue
        try:
            print(f"üì° Probing Node: {url[:30]}...")
            _w3 = Web3(Web3.HTTPProvider(url.strip(), request_kwargs={'timeout': 8}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                print(f"‚úÖ HYDRA PULSE DETECTED: Node Active.")
                return _w3
        except:
            continue
    return None

# Attempting connection
w3 = get_hydra_w3()
if w3 is None:
    print("‚ò¢Ô∏è ERROR: Hydra Engine could not secure a pulse. Retrying in 5s...")
    # In a container, we want to crash and let the restart policy handle it
    import sys; sys.exit(1)

ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=USDC_NATIVE, abi=ERC20_ABI)

# --- 3. AUTH & CLOB ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if (seed.startswith("0x") or len(seed)==64) else "0x"+seed)
    except: return None

vault = get_vault()

from py_clob_client.client import ClobClient
from py_clob_client.clob_types import MarketOrderArgs, OrderType
from py_clob_client.order_builder.constants import BUY

# --- 4. THE DATA BRIDGE (GAMMA DISCOVERY -> CLOB NATIVE ID) ---


async def get_verified_clob_id(condition_id):
    """Bypasses Gamma's data structure to get 100% accurate IDs from the Trading Engine."""
    try:
        url = f"https://clob.polymarket.com/markets/{condition_id}"
        resp = await asyncio.to_thread(requests.get, url, timeout=10)
        data = resp.json()
        # Strictly extract 'Yes' outcome Token ID from the Order Book itself
        for token in data.get('tokens', []):
            if token.get('outcome', '').lower() == 'yes':
                return str(token.get('token_id'))
    except: return None

async def force_scour():
    """AI-Organized Discovery with CLOB-Native Verification."""
    global OMNI_STRIKE_CACHE
    url = "https://gamma-api.polymarket.com/events?active=true&closed=false&limit=30&tag_id=10"
    try:
        resp = await asyncio.to_thread(requests.get, url, timeout=12)
        events = resp.json()
        validated_pool = []

        for e in events:
            m = e.get('markets', [])
            if m and m[0].get('conditionId'):
                cond_id = m[0]['conditionId']
                # Cross-verify ID with the actual trading engine
                v_tid = await get_verified_clob_id(cond_id)
                if v_tid:
                    validated_pool.append({
                        "name": e.get('title')[:22],
                        "token_id": v_tid,
                        "vol": float(e.get('volumeNum', 0))
                    })

        validated_pool.sort(key=lambda x: x['vol'], reverse=True)
        OMNI_STRIKE_CACHE = validated_pool[:8]
        return True
    except: return False

# --- 5. UI & ATOMIC EXECUTION ---
async def start(update, context):
    kb = [['‚öîÔ∏è START SNIPER', '‚öôÔ∏è CALIBRATE'], ['üí≥ VAULT', 'üîÑ REFRESH']]
    await update.message.reply_text(f"{LOGO}\n<b>HYDRA SYSTEM READY</b>", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    if update.message.text in ['‚öîÔ∏è START SNIPER', 'üîÑ REFRESH']:
        msg = await update.message.reply_text("üåÄ <b>PULSING HYDRA NODES...</b>")
        success = await force_scour()
        await msg.delete()
        if not success or not OMNI_STRIKE_CACHE:
            await update.message.reply_text("‚ò¢Ô∏è <b>API BRIDGE TIMEOUT.</b>")
            return
        kb = [[InlineKeyboardButton(f"‚Çø {p['name']}", callback_data=f"HIT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
        context.user_data['paths'] = OMNI_STRIKE_CACHE
        await update.message.reply_text("üåå <b>AI-VALIDATED TARGETS:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "HIT_" in query.data:
        idx = int(query.data.split("_")[1]); target = context.user_data['paths'][idx]
        kb = [[InlineKeyboardButton("‚úÖ CONFIRM & ATOMIC STRIKE", callback_data=f"EXEC_{idx}")]]
        await query.edit_message_text(f"üöÄ <b>TARGET:</b> {target['name']}\nüÜî <b>CLOB_ID:</b> <code>{target['token_id']}</code>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif "EXEC_" in query.data:
        idx = int(query.data.split("_")[1]); target = context.user_data['paths'][idx]
        stake = float(context.user_data.get('stake', 10))
        
        # Fresh client initialization to avoid timestamp drift
        client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=1, funder=vault.address)
        
        try:
            order = await asyncio.to_thread(client.create_market_order, MarketOrderArgs(
                token_id=str(target['token_id']), amount=stake, side=BUY
            ))
            resp = await asyncio.to_thread(client.post_order, order, OrderType.FOK)
            msg = "‚úÖ SUCCESS" if resp.get("success") else f"‚ùå FAIL: {resp.get('errorMsg')}"
            await context.bot.send_message(query.message.chat_id, msg, parse_mode='HTML')
        except Exception as e:
            await context.bot.send_message(query.message.chat_id, f"‚ò¢Ô∏è ERROR: {str(e)[:100]}", parse_mode='HTML')

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































