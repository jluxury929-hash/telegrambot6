import os, asyncio, json, random, time, requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG & ELITE DESIGN ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

# ULTRA-SPEED RAM BUFFER
PRELOADED_WINNERS = []

# ELITE CENTERED ASCII ASSETS
LOGO = """
<code>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• 
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—
â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• v95.0</code>
"""

WIN_LOGO = """
<code>          â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
          â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
           â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
            â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
             â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
             â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•

               .-----------------.
              |   STRIKE RECEIVED   |
              |     LOAD X2 CAD     |
               '._==_==_=_.'
            .-\\:      /-.
           | (|:.     |) |
            '-|:.     |-'
              \\::.    /
               '::. .'
                 ) (
               _.' '._
              `-------`</code>
"""

LOSE_LOGO = """
<code>          â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
          â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
          â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
          â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  
          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
          â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•

                  â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„
                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                 â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ
                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                   â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
                   â–€â–€  â–€â–€  â–€â–€
               [SYSTEM_REVERTED]</code>
"""

# --- 2. HARDENED CONNECTION & AUTH ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        if " " in seed: return Account.from_mnemonic(seed)
        return Account.from_key(seed if seed.startswith("0x") else "0x"+seed)
    except: return None

vault = get_vault()

def get_w3():
    rpc_list = [os.getenv("RPC_URL"), "https://polygon-rpc.com", "https://rpc.ankr.com/polygon"]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

w3 = get_w3()

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except: exit("Missing SDK: pip install py-clob-client")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

# --- 3. DYNAMIC BACKGROUND HARVESTER (THE FIX) ---

async def background_scour_loop():
    """Recursively populates RAM so 'Start Sniper' works 100% of the time."""
    global PRELOADED_WINNERS
    while True:
        try:
            raw = await asyncio.to_thread(clob_client.get_markets)
            pool = [m for m in raw if m.get('active') and "price" in m['question'].lower()]
            if not pool: pool = [m for m in raw if m.get('active')][:20]
            
            market_data = [{"q": m['question'], "id": m['clobTokenIds']} for m in pool[:40]]
            prompt = (f"Analyze: {json.dumps(market_data)}. Pick 8 crypto winners for the next 60m. "
                      "Return JSON: [{'name': 'BTC', 'side': 'UP/DOWN', 'q': 'Short Question', 'token_id': 'ID'}]")
            
            resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt, config={'response_mime_type': 'application/json'})
            winners = json.loads(resp.text)
            if winners:
                PRELOADED_WINNERS = winners
                print(f"âš¡ RAM BUFFER HOT: {len(PRELOADED_WINNERS)} Paths Pre-Loaded.")
        except: pass
        await asyncio.sleep(45)

# --- 4. ATOMIC EXECUTION & STUNNING UI ---

async def execute_atomic_hit(context, chat_id, bet):
    stake = float(context.user_data.get('stake', 50))
    msg = await context.bot.send_message(chat_id, "<code>âš¡ FIRING_ATOMIC_GAUNTLET...</code>", parse_mode='HTML')
    try:
        mid = float(await asyncio.to_thread(clob_client.get_midpoint, bet['token_id']))
        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=bet['token_id'], amount=stake, side=BUY))
        
        # 1ms Hardware Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        if resp.get("success"):
            await context.bot.send_message(chat_id, f"{WIN_LOGO}", parse_mode='HTML')
            await context.bot.send_message(chat_id, f"âœ… <b>VICTORY:</b> <code>${mid:.3f}</code>", parse_mode='HTML')
        else:
            await context.bot.send_message(chat_id, f"{LOSE_LOGO}", parse_mode='HTML')
            await context.bot.send_message(chat_id, "ğŸ›¡ï¸ <b>GUARDED: MATRIX REVERT</b>", parse_mode='HTML')
    except:
        await context.bot.send_message(chat_id, "â˜¢ï¸ <b>DESYNC_ERROR</b>")

# --- 5. INTERFACE ---

async def start(update, context):
    kb = [['âš”ï¸ START SNIPER', 'âš™ï¸ CALIBRATE'], ['ğŸ’³ VAULT', 'ğŸ¤– AUTO-MODE']]
    await update.message.reply_text(f"{LOGO}\n<b>P1_CONNECTED. READY TO STRIKE.</b>", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True), parse_mode='HTML')

async def main_handler(update, context):
    if update.message.text == 'âš”ï¸ START SNIPER':
        # 100% INSTANT: Pulling from RAM, not the internet
        if not PRELOADED_WINNERS:
            status = await update.message.reply_text("ğŸ“¡ <b>INITIALIZING NEURAL LINK...</b>")
            await asyncio.sleep(2)
            if not PRELOADED_WINNERS: return await status.edit_text("âŒ Matrix Cold. Retry in 5s.")
        
        kb = [[InlineKeyboardButton(f"ğŸ¯ {p['name']} | {p['side']} | VERIFIED", callback_data=f"HIT_{i}")] for i, p in enumerate(PRELOADED_WINNERS)]
        context.user_data['paths'] = PRELOADED_WINNERS
        await update.message.reply_text("ğŸŒŒ <b>TARGETS IDENTIFIED:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif update.message.text == 'ğŸ’³ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        report = f"<code>â”Œâ”€â”€ VAULT_AUDIT â”€â”€â”</code>\n  â›½ POL: <code>{w3.from_wei(raw_pol, 'ether'):.4f}</code>\nğŸ“ ID: <code>{vault.address[:10]}...</code>"
        await update.message.reply_text(report, parse_mode='HTML')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "HIT_" in query.data:
        idx = int(query.data.split("_")[1])
        await execute_atomic_hit(context, query.message.chat_id, context.user_data['paths'][idx])

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    
    # Start the Harvester thread IMMEDIATELY
    loop = asyncio.get_event_loop()
    loop.create_task(background_scour_loop())
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































