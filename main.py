import os, asyncio, json, time, requests
import numpy as np
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters
from google import genai
from py_clob_client.client import ClobClient
from py_clob_client.clob_types import MarketOrderArgs, OrderType
from py_clob_client.order_builder.constants import BUY

# --- 1. CONFIG & SYSTEM CORE ---
getcontext().prec = 28
load_dotenv()

ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))
OMNI_STRIKE_CACHE = []

USDC_NATIVE = Web3.to_checksum_address("0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359")
CTF_EXCHANGE = Web3.to_checksum_address("0x4bFbE613d03C895dB366BC36B3D966A488007284")

LOGO = """
<code>‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù v226-FIX-SIZE-ATTR</code>
"""

# --- 2. HYDRA ENGINE ---
def get_hydra_w3():
    endpoints = [os.getenv("RPC_URL"), "https://polygon-rpc.com", "https://1rpc.io/matic"]
    for url in endpoints:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url.strip(), request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                print(f"‚úÖ Hydra Connected: {url[:25]}")
                return _w3
        except: continue
    return None

w3 = get_hydra_w3()
if not w3:
    print("FATAL: RPC Failure."); import sys; sys.exit(1)

ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"}]')
usdc_contract = w3.eth.contract(address=USDC_NATIVE, abi=ERC20_ABI)

# --- 3. VAULT & CLOB INIT ---
def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        return Account.from_mnemonic(seed) if " " in seed else Account.from_key(seed)
    except: return None

vault = get_vault()
clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=1, funder=vault.address)
clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

# --- 4. DATA BRIDGE (NUMPY ENHANCED) ---
async def fetch_market_data(cond_id):
    try:
        url = f"https://clob.polymarket.com/markets/{cond_id}"
        r = await asyncio.to_thread(requests.get, url, timeout=5)
        d = r.json()
        for t in d.get('tokens', []):
            if t.get('outcome', '').lower() == 'yes':
                return str(t.get('token_id')), float(t.get('price', 0.0))
    except: return None, 0.0

async def force_scour():
    global OMNI_STRIKE_CACHE
    tags = [1, 10, 100, 237] 
    raw_results = []
    for tag in tags:
        url = f"https://gamma-api.polymarket.com/events?active=true&closed=false&limit=10&tag_id={tag}"
        try:
            resp = await asyncio.to_thread(requests.get, url, timeout=5)
            for e in resp.json():
                m = e.get('markets', [])
                if m and m[0].get('conditionId'):
                    tid, pr = await fetch_market_data(m[0]['conditionId'])
                    if tid:
                        raw_results.append({
                            "title": e.get('title')[:25],
                            "q": m[0].get('question'),
                            "token_id": tid,
                            "price": pr,
                            "vol": float(e.get('volumeNum', 0))
                        })
        except: continue

    if raw_results:
        vols = np.array([x['vol'] for x in raw_results])
        threshold = np.median(vols)
        OMNI_STRIKE_CACHE = [x for x in raw_results if x['vol'] >= threshold][:8]
        OMNI_STRIKE_CACHE.sort(key=lambda x: x['vol'], reverse=True)
        return True
    return False

# --- 5. TELEGRAM INTERFACE ---
async def start(update, context):
    btns = [['üöÄ START SNIPER', '‚öôÔ∏è CALIBRATE'], ['üîí VAULT', 'üîÑ REFRESH']]
    await update.message.reply_text(f"{LOGO}\n<b>HYDRA-AI SYSTEM ONLINE</b>", 
                                   reply_markup=ReplyKeyboardMarkup(btns, resize_keyboard=True), parse_mode='HTML')

async def handle_text(update, context):
    cmd = update.message.text
    if 'START SNIPER' in cmd or 'REFRESH' in cmd:
        m = await update.message.reply_text("üì° <b>SCANNING POLYGON...</b>", parse_mode='HTML')
        if await force_scour():
            kb = [[InlineKeyboardButton(f"üéØ {p['title']} (${p['price']})", callback_data=f"INT_{i}")] for i, p in enumerate(OMNI_STRIKE_CACHE)]
            await m.edit_text("<b>LIQUID TARGETS FOUND:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')
        else:
            await m.edit_text("‚ùå <b>SCAN FAILED.</b>")

    elif 'VAULT' in cmd:
        bal = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        report = f"<b>VAULT</b>\nUSDC: ${bal/1e6:.2f}\nPOL: {w3.from_wei(pol, 'ether'):.4f}"
        await update.message.reply_text(report, parse_mode='HTML')

    elif 'CALIBRATE' in cmd:
        kb = [[InlineKeyboardButton(f"${x}", callback_data=f"SET_{x}") for x in [10, 50, 100, 250]]]
        await update.message.reply_text("üìä <b>SET STRIKE SIZE (USDC):</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

async def handle_query(update, context):
    q = update.callback_query; await q.answer()
    
    if "SET_" in q.data:
        val = int(q.data.split("_")[1])
        context.user_data['stake'] = val
        await q.edit_message_text(f"‚úÖ <b>STRIKE LOADED: ${val} USDC</b>")

    elif "INT_" in q.data:
        idx = int(q.data.split("_")[1]); target = OMNI_STRIKE_CACHE[idx]
        text = f"<b>INTEL:</b> {target['q']}\n<b>PRICE:</b> ${target['price']}"
        kb = [[InlineKeyboardButton("‚ö° EXECUTE ATOMIC STRIKE", callback_data=f"EXE_{idx}")]]
        await q.edit_message_text(text, reply_markup=InlineKeyboardMarkup(kb), parse_mode='HTML')

    elif "EXE_" in q.data:
        idx = int(q.data.split("_")[1]); target = OMNI_STRIKE_CACHE[idx]
        stake = float(context.user_data.get('stake', 10))
        
        try:
            # 1. Prepare Market Order Args
            order_args = MarketOrderArgs(
                token_id=str(target['token_id']), 
                amount=stake, 
                side=BUY,
                price=0.999
            )
            
            # --- PATCH: Manual injection of 'size' attribute ---
            # For Market Orders, amount and size are functionally the same during the signing check
            setattr(order_args, 'size', stake)

            # 2. Local Signing
            signed_order = await asyncio.to_thread(clob_client.create_order, order_args)
            
            # 3. Post to CLOB
            resp = await asyncio.to_thread(clob_client.post_order, signed_order, OrderType.FOK)
            
            if resp.get("success"):
                msg = f"‚úÖ <b>STRIKE SUCCESS</b>\nID: <code>{resp.get('orderID')}</code>"
            else:
                msg = f"‚ùå <b>FAILED:</b> {resp.get('errorMsg')}"
            
            await context.bot.send_message(q.message.chat_id, msg, parse_mode='HTML')
        except Exception as e:
            await context.bot.send_message(q.message.chat_id, f"‚ö†Ô∏è <b>SDK ERROR:</b> {str(e)}", parse_mode='HTML')

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_query))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_text))
    print("üöÄ Hydra Pulse Active. Scanning for targets..."); app.run_polling()







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































