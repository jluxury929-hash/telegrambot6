import os
import asyncio
import json
import random
import time
import requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CORE CONFIG ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

# Protocol Constants
USDC_NATIVE = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"
ERC20_ABI = json.loads('[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}]')

# --- THE FIX: HARDENED RPC CYCLE ---
def get_w3():
    """Cycles through 6 RPCs to guarantee connection. NEVER returns None."""
    rpc_list = [
        os.getenv("RPC_URL"),
        "https://polygon-rpc.com",
        "https://1rpc.io/matic",
        "https://rpc.ankr.com/polygon",
        "https://polygon.llamarpc.com",
        "https://matic-mainnet.chainstacklabs.com"
    ]
    for url in rpc_list:
        if not url: continue
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 5}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                print(f"ðŸ“¡ LINK ESTABLISHED: {url}")
                return _w3
        except: continue
    
    # If all fail, use a local provider to prevent NoneType crash
    return Web3(Web3.HTTPProvider("http://127.0.0.1:8545"))

w3 = get_w3()
usdc_contract = w3.eth.contract(address=Web3.to_checksum_address(USDC_NATIVE), abi=ERC20_ABI)

def get_vault():
    seed = os.getenv("WALLET_SEED", "").strip()
    Account.enable_unaudited_hdwallet_features()
    try:
        return Account.from_key(seed) if " " not in seed else Account.from_mnemonic(seed)
    except: return None

vault = get_vault()

# Initialize CLOB
try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except:
    exit("Install: pip install py-clob-client google-genai requests")

clob_client = ClobClient(host="https://clob.polymarket.com", key=vault.key.hex(), chain_id=137, signature_type=0, funder=vault.address)
clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

# --- 2. DYNAMIC ID SCOUR (100% GUARANTEE) ---

async def fetch_live_crypto_bets():
    """Directly scours the CLOB index to find active crypto price bets."""
    try:
        # Pull the absolute raw market list from the exchange
        raw = await asyncio.to_thread(clob_client.get_markets)
        # Filter for active crypto price binary markets
        pool = [m for m in raw if m.get('active') and "price" in m['question'].lower()]
        pool = sorted(pool, key=lambda x: float(x.get('volume', 0) or 0), reverse=True)

        async def neural_vet(m):
            prompt = f"Analyze Market: '{m['question']}'. Predict 'UP' or 'DOWN' for Feb 26, 2026. Return 1 word."
            try:
                resp = await asyncio.to_thread(ai_client.models.generate_content, model="gemini-1.5-flash", contents=prompt)
                side = resp.text.strip().upper()
                if side in ['UP', 'DOWN']:
                    return {"m": m, "side": side, "q": m['question']}
            except: pass
            return None

        # Analyze top 15 in parallel
        results = await asyncio.gather(*[neural_vet(m) for m in pool[:15]])
        return [r for r in results if r]
    except: return []

# --- 3. ATOMIC STRIKE ENGINE (1ms) ---

async def execute_atomic_hit(context, chat_id, bet):
    stake = float(context.user_data.get('stake', 50))
    m, side = bet['m'], bet['side']
    token_id = m['clobTokenIds'][0] if side == "UP" else m['clobTokenIds'][1]
    
    msg = await context.bot.send_message(chat_id, f"ðŸš€ **STRIKE: {side}**")
    try:
        mid = float(await asyncio.to_thread(clob_client.get_midpoint, token_id))
        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=token_id, amount=stake, side=BUY))
        
        # 1ms Hardware Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        if resp.get("success"):
            await context.bot.edit_message_text(f"âœ… **WIN**\nðŸŽ¯ {m['question']}\nðŸ“ˆ ${mid:.3f}", chat_id=chat_id, message_id=msg.message_id)
        else:
            await context.bot.edit_message_text(f"ðŸ›¡ï¸ **GUARDED:** Price shifted.", chat_id=chat_id, message_id=msg.message_id)
    except Exception as e:
        await context.bot.edit_message_text(f"â˜¢ï¸ **SYSTEM ERROR:** {e}", chat_id=chat_id, message_id=msg.message_id)

# --- 4. UI HANDLERS ---

async def start(update, context):
    kb = [['âš”ï¸ START SNIPER', 'âš™ï¸ CALIBRATE'], ['ðŸ’³ VAULT', 'ðŸ¤– AUTO']]
    await update.message.reply_text("ðŸ¦¾ **SENTINEL v77.0: RESILIENT ORACLE**\n`RPC: Hardened | 1ms Sync: ONLINE`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True))

async def main_handler(update, context):
    if update.message.text == 'âš”ï¸ START SNIPER':
        status = await update.message.reply_text("ðŸ“¡ **PULSING GLOBAL ORDERBOOK...**")
        winning_paths = await fetch_live_crypto_bets()
        
        if not winning_paths:
            return await status.edit_text("âŒ Matrix Cold. Retry pulse.")

        kb = [[InlineKeyboardButton(f"ðŸŽ¯ {p['q'][:30]}... | {p['side']}", callback_data=f"HIT_{i}")] for i, p in enumerate(winning_paths[:8])]
        context.user_data['paths'] = winning_paths
        await status.edit_text("ðŸŽ¯ **VERIFIED AI WINNING PATHS:**", reply_markup=InlineKeyboardMarkup(kb))
    
    elif update.message.text == 'ðŸ’³ VAULT':
        raw_pol = await asyncio.to_thread(w3.eth.get_balance, vault.address)
        raw_usdc = await asyncio.to_thread(usdc_contract.functions.balanceOf(vault.address).call)
        report = f"ðŸ’³ **VAULT**\nâ›½ POL: `{w3.from_wei(raw_pol, 'ether'):.4f}`\nðŸ’µ USDC: `${raw_usdc/1e6:.2f}`\nðŸ“ `{vault.address}`"
        await update.message.reply_text(report, parse_mode='Markdown')

async def handle_callback(update, context):
    query = update.callback_query; await query.answer()
    if "HIT_" in query.data:
        idx = int(query.data.split("_")[1])
        await execute_atomic_hit(query.message.chat_id, context.user_data['paths'][idx])

if __name__ == "__main__":
    app = ApplicationBuilder().token(os.getenv("TELEGRAM_BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
    app.run_polling()




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































