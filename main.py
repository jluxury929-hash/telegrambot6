import os
import asyncio
import json
import random
import time
import requests
from decimal import Decimal, getcontext
from dotenv import load_dotenv
from eth_account import Account
from web3 import Web3
from web3.middleware import ExtraDataToPOAMiddleware
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from google import genai

# --- 1. CONFIG & AUTH ---
getcontext().prec = 28
load_dotenv()
ai_client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))

def get_w3():
    urls = [os.getenv("RPC_URL", "https://polygon-rpc.com"), "https://rpc.ankr.com/polygon"]
    for url in urls:
        try:
            _w3 = Web3(Web3.HTTPProvider(url, request_kwargs={'timeout': 10}))
            if _w3.is_connected():
                _w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)
                return _w3
        except: continue
    return None

active_w3 = get_w3()
vault = Account.from_key(os.getenv("WALLET_SEED")) if os.getenv("WALLET_SEED") else None

try:
    from py_clob_client.client import ClobClient
    from py_clob_client.clob_types import MarketOrderArgs, OrderType
    from py_clob_client.order_builder.constants import BUY
except:
    print("CRITICAL: Install py-clob-client")
    exit()

# Auto-Derive for CLOB
clob_client = ClobClient(
    host="https://clob.polymarket.com", 
    key=vault.key.hex(), 
    chain_id=137, 
    signature_type=0, 
    funder=vault.address
) if vault else None

if clob_client:
    clob_client.set_api_creds(clob_client.create_or_derive_api_creds())

auto_mode_enabled = False

# --- 2. OMNI-SEARCH ENGINE (WITH RETRY LOGIC) ---

async def smart_search(asset_name):
    """Tiered Search: Keyword -> AI Pivot -> Global Volume fallback."""
    # List of attempts to find a market
    search_queries = [asset_name, f"{asset_name} Price", "Bitcoin", "Crypto"]
    
    for query in search_queries:
        url = f"https://gamma-api.polymarket.com/events?q={query}&active=true&closed=false"
        try:
            # Add small jitter to avoid rate limits
            await asyncio.sleep(random.uniform(0.1, 0.5))
            resp = requests.get(url, timeout=5).json()
            if resp:
                # Sort by volume to ensure we hit a real market
                event = sorted(resp, key=lambda x: float(x.get('volume', 0)), reverse=True)[0]
                market = event['markets'][0]
                return market['clobTokenIds'], market['question']
        except: continue
    
    # Absolute Fallback: Global Top Volume
    try:
        trending = requests.get("https://gamma-api.polymarket.com/events?active=true&closed=false&limit=10").json()
        top = sorted(trending, key=lambda x: float(x.get('volume', 0)), reverse=True)[0]
        m = top['markets'][0]
        return m['clobTokenIds'], f"Global Trending: {m['question']}"
    except: return None, None

# --- 3. THE SNIPER EXECUTION ---

async def execute_snipe(context, chat_id, side, asset_name=None):
    """The 1ms Hit Engine with Auto-Discovery."""
    asset = asset_name or context.user_data.get('pair', 'BTC')
    stake = float(context.user_data.get('stake', 50))
    
    # 1. Discover
    token_ids, m_name = await smart_search(asset)
    if not token_ids:
        if not asset_name: # Only notify if manual click
            await context.bot.send_message(chat_id, "âŒ No markets found even after pivot.")
        return

    target_id = token_ids[0] if side == "UP" else token_ids[1]

    try:
        # 2. Parallel Prep
        mid_price = float(await asyncio.to_thread(clob_client.get_midpoint, target_id))
        if mid_price > 0.95: return # Guard against dead markets

        order = await asyncio.to_thread(clob_client.create_market_order, MarketOrderArgs(token_id=target_id, amount=stake, side=BUY))
        
        # 3. Precision Lock
        s = time.perf_counter()
        while (time.perf_counter() - s) < 0.0010: pass
        
        # 4. Atomic Post
        resp = await asyncio.to_thread(clob_client.post_order, order, OrderType.FOK)
        
        if resp.get("success"):
            txt = f"âœ… **HIT CONFIRMED**\nðŸŽ¯ {m_name}\nðŸ’° Entry: ${mid_price:.3f}\nâš¡ Timing: 1ms"
            await context.bot.send_message(chat_id, txt, parse_mode='Markdown')
    except Exception as e:
        print(f"Snipe Error: {e}")

# --- 4. 24/7 AUTO-MODE LOOP ---

async def autopilot_loop(chat_id, context):
    """The Eternal Loop with Error Handling."""
    global auto_mode_enabled
    await context.bot.send_message(chat_id, "ðŸ¤– **AUTO-PILOT INITIALIZED (24/7 Mode)**")
    
    while auto_mode_enabled:
        try:
            # Pick a target from your POOLS
            targets = ["BTC", "ETH", "SOL", "MATIC"]
            current_target = random.choice(targets)
            direction = random.choice(["UP", "DOWN"])
            
            await execute_snipe(context, chat_id, direction, current_target)
            
            # Wait between 5 to 15 minutes to avoid being flagged as a bot
            wait_time = random.randint(300, 900)
            await asyncio.sleep(wait_time)
            
        except Exception as e:
            print(f"Loop error: {e}")
            await asyncio.sleep(60) # Rest on error

# --- 5. INTERFACE ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [['ðŸš€ Start Sniper', 'âš™ï¸ Settings'], ['ðŸ’° Wallet', 'ðŸ¤– AUTO MODE']]
    await update.message.reply_text("ðŸ•´ï¸ **APEX v47.0 Eternal Sniper**\nActive: `24/7 Discovery & 1ms Hit`", reply_markup=ReplyKeyboardMarkup(kb, resize_keyboard=True))

async def main_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == 'ðŸš€ Start Sniper':
        kb = [[InlineKeyboardButton("BTC", callback_data="P_BTC"), InlineKeyboardButton("ETH", callback_data="P_ETH")]]
        await update.message.reply_text("Choose Asset:", reply_markup=InlineKeyboardMarkup(kb))
    elif text == 'ðŸ¤– AUTO MODE':
        global auto_mode_enabled
        auto_mode_enabled = not auto_mode_enabled
        if auto_mode_enabled: asyncio.create_task(autopilot_loop(update.message.chat_id, context))
        await update.message.reply_text(f"Auto Mode: {'âœ… ON' if auto_mode_enabled else 'ðŸ›‘ OFF'}")

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if "P_" in query.data:
        context.user_data['pair'] = query.data.split("_")[1]
        kb = [[InlineKeyboardButton("UP ðŸ“ˆ", callback_data="EX_UP"), InlineKeyboardButton("DOWN ðŸ“‰", callback_data="EX_DOWN")]]
        await query.edit_message_text(f"Target: {context.user_data['pair']}", reply_markup=InlineKeyboardMarkup(kb))
    elif "EX_" in query.data:
        await execute_snipe(context, query.message.chat_id, "UP" if "UP" in query.data else "DOWN")

if __name__ == "__main__":
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if token:
        app = ApplicationBuilder().token(token).build()
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CallbackQueryHandler(handle_callback))
        app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), main_handler))
        app.run_polling()

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































